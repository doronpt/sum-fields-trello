<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sum Up Fields Settings</title>
  <link rel="stylesheet" href="./css/styles.css">
  <style>
    .settings-container {
      padding: 0;
      background: #f4f5f7;
      min-height: 100vh;
    }
    
    .settings-header {
      background: white;
      padding: 20px;
      border-bottom: 1px solid #dfe1e6;
      margin-bottom: 20px;
    }
    
    .settings-header h2 {
      margin: 0;
      color: #172b4d;
      font-size: 20px;
    }
    
    .settings-content {
      padding: 0 20px;
    }
    
    .add-field-section {
      background: white;
      border-radius: 3px;
      box-shadow: 0 1px 0 rgba(9,30,66,.25);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .fields-list-section {
      background: white;
      border-radius: 3px;
      box-shadow: 0 1px 0 rgba(9,30,66,.25);
      padding: 20px;
    }
    
    .field-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f1f2f4;
    }
    
    .field-item:last-child {
      border-bottom: none;
    }
    
    .field-info {
      flex: 1;
    }
    
    .field-name {
      font-weight: 600;
      color: #172b4d;
      font-size: 14px;
    }
    
    .field-description {
      color: #5e6c84;
      font-size: 12px;
      margin-top: 2px;
    }
    
    .btn-remove {
      background: #b04632;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .btn-remove:hover {
      background: #933b27;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #5e6c84;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .success-message {
      background: #e3fcef;
      border: 1px solid #00c896;
      color: #006644;
      padding: 12px;
      border-radius: 3px;
      margin-bottom: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="settings-container">
    <div class="settings-header">
      <h2>‚öôÔ∏è Sum Up Fields Settings</h2>
      <p style="margin: 8px 0 0 0; color: #5e6c84; font-size: 14px;">
        Configure custom numeric fields for your cards. Fields will be available on all cards in this board.
      </p>
    </div>
    
    <div class="settings-content">
      <div class="success-message" id="successMessage">
        ‚úÖ Settings saved successfully!
      </div>
      
      <div class="add-field-section">
        <h3>Add New Field</h3>
        <div class="form-group">
          <label for="fieldName">Field Name:</label>
          <input type="text" id="fieldName" placeholder="e.g., Story Points, Hours, Cost, Priority" maxlength="50">
        </div>
        <button class="btn" onclick="addField()">Add Field</button>
      </div>

      <div class="fields-list-section">
        <h3>Configured Fields</h3>
        <div id="fieldsList">
          <!-- Fields will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    const t = TrelloPowerUp.iframe();
    const FIELDS_KEY = 'sumup_fields';

    function generateId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    function showSuccess() {
      const message = document.getElementById('successMessage');
      message.style.display = 'block';
      setTimeout(function() {
        message.style.display = 'none';
      }, 3000);
    }

    function loadFields() {
      t.get('board', 'shared', FIELDS_KEY)
        .then(function(fields) {
          fields = fields || [];
          const fieldsList = document.getElementById('fieldsList');
          
          if (fields.length === 0) {
            fieldsList.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <h4>No fields configured yet</h4>
                <p>Add your first numeric field above to get started.<br>
                Examples: Story Points, Hours, Cost, Priority</p>
              </div>
            `;
            return;
          }
          
          fieldsList.innerHTML = '';
          fields.forEach(function(field, index) {
            const fieldItem = document.createElement('div');
            fieldItem.className = 'field-item';
            fieldItem.innerHTML = `
              <div class="field-info">
                <div class="field-name">${field.name}</div>
                <div class="field-description">Numeric field ‚Ä¢ Available on all cards</div>
              </div>
              <button class="btn-remove" onclick="removeField('${field.id}')">Remove</button>
            `;
            fieldsList.appendChild(fieldItem);
          });
        })
        .catch(function(error) {
          console.error('Error loading fields:', error);
          document.getElementById('fieldsList').innerHTML = '<p style="color: #b04632;">Error loading fields. Please refresh and try again.</p>';
        });
    }

    function addField() {
      const fieldName = document.getElementById('fieldName').value.trim();
      
      if (!fieldName) {
        alert('Please enter a field name');
        return;
      }

      if (fieldName.length > 50) {
        alert('Field name must be 50 characters or less');
        return;
      }

      t.get('board', 'shared', FIELDS_KEY)
        .then(function(fields) {
          fields = fields || [];
          
          // Check if field name already exists
          const exists = fields.some(function(field) {
            return field.name.toLowerCase() === fieldName.toLowerCase();
          });
          
          if (exists) {
            alert('A field with this name already exists');
            return;
          }
          
          const newField = {
            id: generateId(),
            name: fieldName,
            created: new Date().toISOString()
          };
          
          fields.push(newField);
          
          return t.set('board', 'shared', FIELDS_KEY, fields);
        })
        .then(function() {
          document.getElementById('fieldName').value = '';
          loadFields();
          showSuccess();
        })
        .catch(function(error) {
          console.error('Error adding field:', error);
          alert('Error adding field. Please try again.');
        });
    }

    function removeField(fieldId) {
      if (!confirm('Are you sure you want to remove this field?\n\nThis will delete all values for this field across all cards and cannot be undone.')) {
        return;
      }

      t.get('board', 'shared', FIELDS_KEY)
        .then(function(fields) {
          fields = fields || [];
          const updatedFields = fields.filter(function(field) {
            return field.id !== fieldId;
          });
          
          return t.set('board', 'shared', FIELDS_KEY, updatedFields);
        })
        .then(function() {
          loadFields();
          showSuccess();
          
          // TODO: Clean up field values from all cards
          // This would require iterating through all cards and removing the field values
          // For now, we'll leave the old values (they won't be displayed anyway)
        })
        .catch(function(error) {
          console.error('Error removing field:', error);
          alert('Error removing field. Please try again.');
        });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadFields();
      
      // Allow Enter key to add field
      document.getElementById('fieldName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          addField();
        }
      });
    });
  </script>
</body>
</html>