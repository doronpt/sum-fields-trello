<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Edit Field Values</title>
  <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
  <div class="field-config">
    <h3>Field Values for This Card</h3>
    <div id="fieldsContainer">
      <!-- Fields will be loaded here -->
    </div>
    <button class="btn" onclick="saveValues()">Save Values</button>
    <button class="btn btn-secondary" onclick="t.closePopup()">Cancel</button>
  </div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    const t = TrelloPowerUp.iframe();
    const FIELDS_KEY = 'sumup_fields';
    const FIELD_VALUES_KEY = 'sumup_field_values';

    function loadFieldValues() {
      Promise.all([
        t.get('board', 'shared', FIELDS_KEY),
        t.get('card', 'shared', FIELD_VALUES_KEY)
      ])
      .then(function([fields, values]) {
        fields = fields || [];
        values = values || {};
        
        const container = document.getElementById('fieldsContainer');
        
        if (fields.length === 0) {
          container.innerHTML = '<p>No fields available. Create fields first using the "Manage Fields" button on the board.</p>';
          return;
        }
        
        container.innerHTML = '';
        
        fields.forEach(function(field) {
          const fieldValue = values[field.id] || 0;
          
          const fieldGroup = document.createElement('div');
          fieldGroup.className = 'form-group';
          fieldGroup.innerHTML = `
            <label for="field_${field.id}">${field.name}:</label>
            <input type="number" 
                   id="field_${field.id}" 
                   value="${fieldValue}" 
                   min="0" 
                   step="0.01"
                   data-field-id="${field.id}">
          `;
          
          container.appendChild(fieldGroup);
        });
      })
      .catch(function(error) {
        console.error('Error loading field values:', error);
        document.getElementById('fieldsContainer').innerHTML = '<p>Error loading fields. Please try again.</p>';
      });
    }

    function saveValues() {
      const inputs = document.querySelectorAll('input[data-field-id]');
      const values = {};
      
      inputs.forEach(function(input) {
        const fieldId = input.getAttribute('data-field-id');
        const value = parseFloat(input.value) || 0;
        values[fieldId] = value;
      });
      
      console.log('Saving field values:', values);
      
      t.set('card', 'shared', FIELD_VALUES_KEY, values)
        .then(function() {
          console.log('Values saved successfully');
          // Update all list sums before closing
          return updateAllListSums();
        })
        .then(function() {
          console.log('All list sums updated');
          // Notify parent that we're done and close popup
          return t.notifyParent('done').then(function() {
            return t.closePopup();
          }).catch(function() {
            // If notify fails, still close popup
            return t.closePopup();
          });
        })
        .catch(function(error) {
          console.error('Error saving values:', error);
          alert('Error saving values. Please try again.');
        });
    }

    function updateAllListSums() {
      return Promise.all([
        t.cards('id', 'idList', 'name', 'pos'),
        t.get('board', 'shared', FIELDS_KEY)
      ]).then(function(results) {
        const allCards = results[0];
        const fields = results[1];

        if (!fields || fields.length === 0) {
          return;
        }

        // Group cards by list and sort by position
        const cardsByList = {};
        allCards.forEach(function(card) {
          if (!cardsByList[card.idList]) {
            cardsByList[card.idList] = [];
          }
          cardsByList[card.idList].push(card);
        });

        // Sort cards in each list by position
        Object.keys(cardsByList).forEach(function(listId) {
          cardsByList[listId].sort(function(a, b) {
            return a.pos - b.pos;
          });
        });

        // Process each list
        const listPromises = Object.keys(cardsByList).map(function(listId) {
          const listCards = cardsByList[listId];
          
          if (listCards.length <= 1) {
            return Promise.resolve(); // No need to calculate sum for lists with 0 or 1 card
          }

          // Calculate sums for cards after the first one
          const sums = {};
          fields.forEach(function(field) {
            sums[field.id] = 0;
          });

          const cardsToSum = listCards.slice(1);
          const cardPromises = cardsToSum.map(function(card) {
            return t.get(card.id, 'shared', FIELD_VALUES_KEY)
              .then(function(values) {
                if (values) {
                  fields.forEach(function(field) {
                    sums[field.id] += parseFloat(values[field.id]) || 0;
                  });
                }
              })
              .catch(function(error) {
                console.warn('Error getting values for card', card.id, error);
              });
          });

          return Promise.all(cardPromises)
            .then(function() {
              // The main powerup will automatically recalculate when badges are requested
              // We just need to make sure something triggers the badge refresh
              // This can be done by updating a timestamp on the first card
              const firstCard = listCards[0];
              return t.set(firstCard.id, 'shared', 'last_sum_update', Date.now());
            });
        });

        return Promise.all(listPromises);
      }).catch(function(error) {
        console.error('Error updating all list sums:', error);
      });
    }

    t.render(function() {
      updateAllListSums()
        .then(function() {
          console.log('All list sums updated successfully');
        })
        .catch(function(error) {
          console.error('Error updating list sums:', error);
        });
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadFieldValues();
    });
  </script>
</body>
</html>